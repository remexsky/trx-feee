version: '3.8'

services:
  # Nacos - 注册中心和配置中心
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: nacos
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    environment:
      - MODE=standalone
      - NACOS_AUTH_ENABLE=false
      - NACOS_AUTH_TOKEN=SecretKey012345678901234567890123456789012345678901234567890123456789
      - NACOS_AUTH_IDENTITY_KEY=serverIdentity
      - NACOS_AUTH_IDENTITY_VALUE=security
    volumes:
      - ./nacos/data:/home/nacos/data
      - ./nacos/logs:/home/nacos/logs
    restart: always

  # MySQL - 关系型数据库
  mysql:
    image: mysql:8.0.33
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=trx_feee
      - MYSQL_USER=trx_feee
      - MYSQL_PASSWORD=trx_feee_password
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql/conf:/etc/mysql/conf.d
      - ./mysql/init:/docker-entrypoint-initdb.d
    command:
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=1000
      --wait_timeout=300
    restart: always

  # Redis - 缓存
  redis:
    image: redis:7.0.12
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - ./redis/data:/data
      - ./redis/conf/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always

  # RocketMQ - 消息队列
  rocketmq-namesrv:
    image: apache/rocketmq:4.9.5
    container_name: rocketmq-namesrv
    ports:
      - "9876:9876"
    volumes:
      - ./rocketmq/namesrv/logs:/root/logs
    command: sh mqnamesrv
    restart: always

  rocketmq-broker:
    image: apache/rocketmq:4.9.5
    container_name: rocketmq-broker
    ports:
      - "10909:10909"
      - "10911:10911"
    volumes:
      - ./rocketmq/broker/logs:/root/logs
      - ./rocketmq/broker/store:/root/store
      - ./rocketmq/broker/conf/broker.conf:/opt/rocketmq-4.9.5/conf/broker.conf
    environment:
      - NAMESRV_ADDR=rocketmq-namesrv:9876
    command: sh mqbroker -c /opt/rocketmq-4.9.5/conf/broker.conf
    depends_on:
      - rocketmq-namesrv
    restart: always

  # RocketMQ Console
  rocketmq-console:
    image: styletang/rocketmq-console-ng:1.0.0
    container_name: rocketmq-console
    ports:
      - "8082:8080"
    environment:
      - JAVA_OPTS=-Drocketmq.namesrv.addr=rocketmq-namesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false
    depends_on:
      - rocketmq-namesrv
    restart: always

  # Elasticsearch - 搜索引擎
  elasticsearch:
    image: elasticsearch:7.17.12
    container_name: elasticsearch
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - cluster.name=elasticsearch-cluster
      - http.cors.enabled=true
      - http.cors.allow-origin=*
    volumes:
      - ./elasticsearch/data:/usr/share/elasticsearch/data
      - ./elasticsearch/logs:/usr/share/elasticsearch/logs
      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
    restart: always

  # Kibana - Elasticsearch可视化
  kibana:
    image: kibana:7.17.12
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    restart: always

  # Logstash - 日志收集
  logstash:
    image: logstash:7.17.12
    container_name: logstash
    ports:
      - "5044:5044"
      - "9600:9600"
    volumes:
      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml
      - ./logstash/pipeline:/usr/share/logstash/pipeline
    depends_on:
      - elasticsearch
    restart: always

  # Prometheus - 监控
  prometheus:
    image: prom/prometheus:v2.46.0
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/data:/prometheus
    restart: always

  # Grafana - 监控可视化
  grafana:
    image: grafana/grafana:9.5.2
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/config:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    restart: always

  # Sentinel - 流量控制和熔断
  sentinel:
    image: bladex/sentinel-dashboard:1.8.5
    container_name: sentinel
    ports:
      - "8080:8080"
    environment:
      - JAVA_OPTS=-Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard
    restart: always

  # Seata - 分布式事务
  seata-server:
    image: seataio/seata-server:1.6.1
    container_name: seata-server
    ports:
      - "8091:8091"
    environment:
      - SEATA_IP=seata-server
      - SEATA_PORT=8091
      - STORE_MODE=db
      - DB_TYPE=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=trx_feee
      - DB_PASSWORD=trx_feee_password
      - DB_NAME=trx_feee
    depends_on:
      - mysql
    restart: always

# 网络配置
networks:
  default:
    name: trx_feee_network
    driver: bridge

# 卷配置
volumes:
  nacos-data:
  nacos-logs:
  mysql-data:
  mysql-conf:
  mysql-init:
  redis-data:
  redis-conf:
  rocketmq-namesrv-logs:
  rocketmq-broker-logs:
  rocketmq-broker-store:
  elasticsearch-data:
  elasticsearch-logs:
  kibana-data:
  logstash-data:
  prometheus-data:
  grafana-data:
  grafana-config: